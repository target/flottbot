language: go

go:
  - "1.11"

before_install:
  - go get github.com/golang/dep/cmd/dep
  - go get github.com/mattn/goveralls
  - go get github.com/fzipp/gocyclo

before_script:
  - echo $TRAVIS_COMMIT
  - echo $TRAVIS_TAG
  - echo $TRAVIS_BRANCH
  - echo $TRAVIS_BUILD_NUMBER
  - echo $TRAVIS_REPO_SLUG
  - dep ensure

script:
  - go vet $(go list ./... | grep -v vendor)
  - go test -v -race  -coverprofile=coverage.out $(go list ./... | grep -v vendor)
  - gocyclo -over 18 `find . -iname '*.go' | grep -v vendor | grep -v '_test.go'`
  - $GOPATH/bin/goveralls -coverprofile=coverage.out -service=travis-ci

before_deploy:
  - go get github.com/mitchellh/gox
  - gox -ldflags "-X github.com/target/flottbot/version.Version=${TRAVIS_TAG} -X github.com/target/flottbot/version.GitHash=${TRAVIS_COMMIT}" -os="linux darwin windows" -arch="amd64" -verbose ./...
  - ./tar-release.sh

deploy:
  provider: releases
  api_key:
    secure: <insert_secure_token>
  file_glob: true
  file: "*.tgz"
  skip_cleanup: true
  on:
    tags: true
